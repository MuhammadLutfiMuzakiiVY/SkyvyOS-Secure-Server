#!/usr/sbin/nft -f
################################################################################
# SkyvyOS Secure Server - Production nftables Configuration
#
# Features:
# - Default-deny policy
# - DDoS protection (SYN flood, ping flood)
# - Rate limiting (SSH, HTTP/HTTPS)
# - IPv4 + IPv6 support
# - Connection tracking
# - Stateful firewall
#
# Usage:
#   systemctl enable nftables
#   nft -f /etc/nftables.conf
#   systemctl start nftables
################################################################################

# Flush all existing rules
flush ruleset

#
# Variables - Customize for your environment
#
define SSH_PORT = 22
define HTTP_PORT = 80
define HTTPS_PORT = 443

# Additional custom ports (example)
# define CUSTOM_APP_PORT = 3000

# Trusted networks (example: office, VPN)
# define TRUSTED_NETS = { 192.168.1.0/24, 10.8.0.0/24 }

#
# Main filter table
#
table inet filter {
    
    #
    # IP sets for dynamic management
    #
    set blacklist {
        type ipv4_addr
        flags timeout
        timeout 1h
    }
    
    set whitelist {
        type ipv4_addr
        flags constant
        # elements = { 192.168.1.100, 10.0.0.50 }
    }
    
    #
    # INPUT chain - Incoming connections
    #
    chain input {
        type filter hook input priority 0; policy drop;
        
        # Performance optimization: early accept for established
        ct state established,related accept comment "Accept established connections"
        
        # Loopback interface
        iif lo accept comment "Accept loopback"
        
        # Drop invalid packets early
        ct state invalid drop comment "Drop invalid packets"
        
        # Whitelist bypass
        # ip saddr @whitelist accept comment "Whitelist"
        
        # Blacklist drop
        ip saddr @blacklist drop comment "Blacklist"
        
        #
        # ICMP (ping) - Rate limited
        #
        ip protocol icmp icmp type echo-request limit rate 5/second accept comment "Allow ping (rate limited)"
        ip protocol icmp icmp type echo-request drop comment "Drop excess ping"
        
        # ICMPv6 (essential for IPv6 functionality)
        ip6 nexthdr icmpv6 icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, echo-request, echo-reply } accept
        ip6 nexthdr icmpv6 icmpv6 type { nd-neighbor-solicit, nd-neighbor-advert, nd-router-advert, nd-router-solicit } accept
        
        #
        # SSH - Aggressive rate limiting
        #
        tcp dport $SSH_PORT ct state new limit rate 3/minute burst 5 packets accept comment "SSH with rate limit"
        tcp dport $SSH_PORT drop comment "Drop excess SSH attempts"
        
        #
        # HTTP/HTTPS - Connection limiting
        #
        tcp dport $HTTP_PORT ct state new limit rate 100/second burst 200 packets accept comment "HTTP"
        tcp dport $HTTPS_PORT ct state new limit rate 100/second burst 200 packets accept comment "HTTPS"
        
        #
        # Custom application ports (uncomment if needed)
        #
        # tcp dport 3000 accept comment "Node.js app"
        # tcp dport 8080 accept comment "Alternative HTTP"
        
        #
        # DDoS Protection
        #
        
        # Drop SYN packets with suspicious MSS value
        tcp flags syn tcp option maxseg size 1-536 drop comment "Drop suspicious SYN"
        
        # Drop fragmented packets
        ip frag-off & 0x1fff != 0 drop comment "Drop fragments"
        
        # Drop XMAS packets
        tcp flags & (fin|syn|rst|psh|ack|urg) == fin|syn|rst|psh|ack|urg drop comment "Drop XMAS"
        
        # Drop NULL packets
        tcp flags & (fin|syn|rst|psh|ack|urg) == 0x0 drop comment "Drop NULL"
        
        # Drop FIN without ACK
        tcp flags & (fin|ack) == fin drop comment "Drop FIN without ACK"
        
        #
        # Rate limit new connections per source IP
        #
        ct count over 100 drop comment "Drop excessive connections from single IP"
        
        #
        # Logging (uncomment for debugging)
        #
        # limit rate 5/minute burst 10 packets log prefix "nftables-input-drop: " level info
        
        # Reject with informative message (better than silent drop for some protocols)
        reject with icmpx type port-unreachable
    }
    
    #
    # FORWARD chain - Usually for routers/NAT (Docker uses this)
    #
    chain forward {
        type filter hook forward priority 0; policy drop;
        
        # Accept established/related
        ct state established,related accept
        
        # Docker bridge (if using Docker)
        iifname "docker0" accept comment "Docker bridge"
        oifname "docker0" ct state related,established accept comment "Docker return traffic"
    }
    
    #
    # OUTPUT chain - Outgoing connections
    #
    chain output {
        type filter hook output priority 0; policy accept;
        
        # Allow all outgoing by default
        # For egress filtering, change policy to drop and add specific rules
        
        # Example egress filtering (uncomment if needed):
        # ct state established,related accept
        # oif lo accept
        # tcp dport { 80, 443, 22 } accept comment "Allow HTTP, HTTPS, SSH out"
        # udp dport 53 accept comment "Allow DNS out"
        # reject
    }
}

#
# NAT table (if needed for Docker, port forwarding, etc)
#
table ip nat {
    chain prerouting {
        type nat hook prerouting priority -100;
        
        # Example: Port forwarding
        # iif eth0 tcp dport 8080 dnat to 192.168.1.100:80
    }
    
    chain postrouting {
        type nat hook postrouting priority 100;
        
        # Example: Masquerade for Docker
        # oifname eth0 masquerade
    }
}

#
# Optional: Mangle table for QoS/packet marking
#
# table inet mangle {
#     chain prerouting {
#         type filter hook prerouting priority -150;
#     }
# }
